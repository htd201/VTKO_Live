<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICKOFF 2026 - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Khởi tạo Firebase với cấu trúc an toàn
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vthc-kickoff-2026';

        // Xử lý đăng nhập để hiện trạng thái
        onAuthStateChanged(auth, (user) => {
            const statusEl = document.getElementById('connection-status');
            if (user) {
                statusEl.innerHTML = '<span class="flex h-2 w-2 rounded-full bg-emerald-500"></span> Trực tuyến';
                statusEl.classList.replace('text-slate-400', 'text-emerald-400');
            }
        });

        // Lắng nghe dữ liệu từ iFrame gửi lên
        window.addEventListener('message', async (event) => {
            if (event.data && event.data.type === 'SYNC_DATA') {
                const { module, data } = event.data;
                if (!auth.currentUser) return;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'live_results');
                    const docSnap = await getDoc(docRef);
                    let cloudData = docSnap.exists() ? docSnap.data() : {};
                    cloudData[module] = data;
                    await setDoc(docRef, cloudData);
                    console.log("Đã đồng bộ thành công môn:", module);
                } catch (e) { console.error("Lỗi đồng bộ:", e); }
            }
        });

        signInAnonymously(auth);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .sidebar-item.active { background: #0f766e; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        iframe { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-slate-900 text-white overflow-hidden">

    <div class="flex h-screen w-full">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col shrink-0">
            <div class="p-6 border-b border-slate-700">
                <h1 class="font-black text-xl tracking-tighter text-emerald-500">KICKOFF 2026</h1>
                <div id="connection-status" class="text-[10px] font-bold uppercase mt-1 flex items-center gap-2 text-slate-400">
                    <span class="flex h-2 w-2 rounded-full bg-slate-600 animate-pulse"></span> Đang kết nối...
                </div>
            </div>

            <nav class="p-4 space-y-2 flex-1">
                <button onclick="switchModule('football', 'bongda.html')" id="btn-football" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-700 transition-all text-slate-300 font-semibold text-sm">
                    <i data-lucide="trophy" class="w-4 h-4"></i> Bóng đá
                </button>
                <button onclick="switchModule('badminton', 'caulong.html')" id="btn-badminton" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-700 transition-all text-slate-300 font-semibold text-sm">
                    <i data-lucide="activity" class="w-4 h-4"></i> Cầu lông
                </button>
                <button onclick="switchModule('chess', 'covua.html')" id="btn-chess" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-700 transition-all text-slate-300 font-semibold text-sm">
                    <i data-lucide="swords" class="w-4 h-4"></i> Cờ vua
                </button>
            </nav>

            <div class="p-4 border-t border-slate-700">
                <a href="viewer.html" target="_blank" class="flex items-center justify-center gap-2 p-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-xs font-bold uppercase tracking-widest transition-all">
                    <i data-lucide="external-link" class="w-4 h-4"></i> Mở trang Live
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 bg-slate-100 relative">
            <div id="loading-overlay" class="absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center hidden">
                <div class="w-8 h-8 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin mb-2"></div>
                <p class="text-slate-500 font-bold text-[10px] uppercase tracking-widest">Đang tải dữ liệu...</p>
            </div>

            <div id="welcome-screen" class="absolute inset-0 z-20 bg-slate-50 flex flex-col items-center justify-center p-10 text-center">
                <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-3xl flex items-center justify-center mb-6 shadow-sm">
                    <i data-lucide="zap" class="w-10 h-10"></i>
                </div>
                <h2 class="text-slate-900 font-black text-2xl mb-2">Hệ thống sẵn sàng</h2>
                <p class="text-slate-500 text-sm max-w-xs">Chọn môn thi đấu ở menu bên trái để bắt đầu nhập điểm.</p>
                <div class="mt-8 p-4 bg-amber-50 border border-amber-200 rounded-xl text-amber-700 text-[11px] text-left">
                    <strong>Lưu ý GitHub:</strong> Đảm bảo tên file trên GitHub là <code class="bg-amber-100 px-1">bongda.html</code>, <code class="bg-amber-100 px-1">caulong.html</code>, v.v. để không bị lỗi trang trắng.
                </div>
            </div>

            <iframe id="main-frame" class="w-full h-full border-none opacity-0" src="about:blank"></iframe>
        </main>
    </div>

    <script>
        lucide.createIcons();

        function switchModule(id, fileName) {
            // UI Updates
            document.getElementById('welcome-screen').classList.add('hidden');
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-' + id).classList.add('active');
            
            const frame = document.getElementById('main-frame');
            const loading = document.getElementById('loading-overlay');
            
            loading.classList.remove('hidden');
            frame.style.opacity = '0';
            
            // Tải file (Sử dụng đường dẫn tương đối trực tiếp)
            frame.src = fileName;

            frame.onload = () => {
                loading.classList.add('hidden');
                frame.style.opacity = '1';
                console.log("Đã tải xong file:", fileName);
            };

            // Kiểm tra lỗi tải file (Nếu GitHub trả về 404)
            fetch(fileName, { method: 'HEAD' }).then(res => {
                if (!res.ok) {
                    alert(`Lỗi: Không tìm thấy file "${fileName}" trên GitHub. Hãy kiểm tra lại tên file bạn đã upload.`);
                    loading.classList.add('hidden');
                }
            }).catch(() => {});
        }
    </script>
</body>
</html>
